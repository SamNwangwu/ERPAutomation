{
  "Sku": null,
  "ProvisioningState": "Succeeded",
  "CreatedTime": "2025-10-29T13:56:26.2638927Z",
  "ChangedTime": "2025-11-21T16:29:03.3460173Z",
  "State": "Enabled",
  "Version": "08584378643421438269",
  "AccessEndpoint": "https://prod-36.northeurope.logic.azure.com:443/workflows/f37bd269b7f842488ed6da978e8c62e6",
  "IntegrationAccount": null,
  "Definition": {
    "$schema": "https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
      "$connections": {
        "defaultValue": {},
        "type": "Object"
      }
    },
    "triggers": {
      "Recurrence_-_Check_Every_15_Minutes": {
        "recurrence": {
          "frequency": "Minute",
          "interval": 15
        },
        "evaluatedRecurrence": {
          "frequency": "Minute",
          "interval": 15
        },
        "type": "Recurrence"
      }
    },
    "actions": {
      "For_Each_Environment": {
        "foreach": "@body('Get_Items_Needing_Scripts')?['value']",
        "actions": {
          "Check_If_Within_48_Hours": {
            "actions": {
              "Check_if_VMs_Found": {
                "actions": {
                  "Create_Script_File_in_SharePoint": {
                    "runAfter": {
                      "Generate_Script_Content": [
                        "Succeeded"
                      ]
                    },
                    "type": "ApiConnection",
                    "inputs": {
                      "body": "@outputs('Generate_Script_Content')",
                      "host": {
                        "connection": {
                          "name": "@parameters('$connections')['sharepointonline']['connectionId']"
                        }
                      },
                      "method": "post",
                      "path": "/datasets/@{encodeURIComponent(encodeURIComponent('https://lebara.sharepoint.com/sites/ERPConnectionsHub'))}/files",
                      "queries": {
                        "folderPath": "@{concat('/Shared Documents/', toUpper(items('For_Each_Environment')?['Resource_x0020_Group_x0020_Name']))}",
                        "name": "@{concat('Connect-to-', if(empty(items('For_Each_Environment')?['EnvironmentType']?['Value']), 'UNKNOWN', toUpper(items('For_Each_Environment')?['EnvironmentType']?['Value'])), '-', outputs('Set_VM_Details')?['vmName'], '.bat')}",
                        "queryParametersSingleEncoded": true
                      }
                    },
                    "runtimeConfiguration": {
                      "contentTransfer": {
                        "transferMode": "Chunked"
                      }
                    }
                  },
                  "Generate_Script_Content": {
                    "runAfter": {
                      "Set_VM_Details": [
                        "Succeeded"
                      ]
                    },
                    "type": "Compose",
                    "inputs": "@concat('@echo off\r\nsetlocal\r\n\r\n:: ============================================\r\n:: Bastion RDP Connection Script\r\n:: VM: ', outputs('Set_VM_Details')?['vmName'], '\r\n:: Resource Group: ', items('For_Each_Environment')?['Resource_x0020_Group_x0020_Name'], '\r\n:: Generated on: ', utcNow('MM/dd/yyyy HH:mm:ss'), '\r\n:: ============================================\r\n\r\necho.\r\necho ========================================\r\necho Bastion RDP Connection Helper\r\necho VM: ', outputs('Set_VM_Details')?['vmName'], '\r\necho ========================================\r\necho.\r\n\r\necho [Step 1/4] Checking Azure CLI installation...\r\nwhere az >nul 2>&1\r\nif errorlevel 1 (\r\n    echo [ERROR] Azure CLI not found!\r\n    echo.\r\n    echo Please install Azure CLI from: https://aka.ms/installazurecliwindows\r\n    echo Then, restart your terminal and run this script again.\r\n    echo.\r\n    pause\r\n    exit /b 1\r\n)\r\necho [SUCCESS] Azure CLI is installed.\r\necho.\r\n\r\necho [Step 2/4] Checking Azure login status...\r\ncall az account show >nul 2>&1\r\nif errorlevel 1 (\r\n    echo [WARNING] You may not be logged in to Azure.\r\n    echo [INFO] Attempting to log you in now...\r\n    echo [INFO] After login, the script will automatically select ERP Tier 1 Environment.\r\n    call az login\r\n    if errorlevel 1 (\r\n        echo [ERROR] Azure login failed. Please try running ''az login'' manually.\r\n        pause\r\n        exit /b 1\r\n    )\r\n)\r\necho [SUCCESS] Logged in to Azure.\r\necho.\r\n\r\necho [Step 3/4] Setting subscription and checking Bastion extension...\r\ncall az account set --subscription \"8cc0a954-47fb-4878-a768-e195dbd036b7\" >nul 2>&1\r\nif errorlevel 1 (\r\n    echo [ERROR] Failed to set subscription to ERP Tier 1 Environment.\r\n    pause\r\n    exit /b 1\r\n)\r\necho [SUCCESS] Subscription set to ERP Tier 1 Environment.\r\necho.\r\ncall az extension show --name bastion >nul 2>&1\r\nif errorlevel 1 (\r\n    echo [INFO] Bastion extension not found. Installing now...\r\n    call az extension add --name bastion --yes\r\n    if errorlevel 1 (\r\n        echo [ERROR] Failed to install the Bastion extension.\r\n        pause\r\n        exit /b 1\r\n    )\r\n    echo [SUCCESS] Bastion extension installed!\r\n) else (\r\n    echo [SUCCESS] Bastion extension is already installed.\r\n)\r\necho.\r\n\r\necho [Step 4/4] Connecting to VM via Bastion...\r\necho [INFO] This will open a Remote Desktop connection prompt.\r\necho.\r\n\r\ncall az network bastion rdp --name \"bastion-lebara-security-hub\" --resource-group \"rg-lebara-security-hub-northeurope\" --target-resource-id \"', outputs('Set_VM_Details')?['vmResourceId'], '\"\r\n\r\nif errorlevel 1 (\r\n    echo.\r\n    echo [ERROR] Failed to connect to VM via Bastion.\r\n    pause\r\n    exit /b 1\r\n)\r\n\r\necho.\r\necho [SUCCESS] RDP session ended.\r\necho.\r\npause')"
                  },
                  "Send_Script_Ready_Email": {
                    "runAfter": {
                      "Update_SharePoint_Item": [
                        "Succeeded"
                      ]
                    },
                    "type": "Http",
                    "inputs": {
                      "method": "POST",
                      "authentication": {
                        "type": "ManagedServiceIdentity",
                        "audience": "https://graph.microsoft.com"
                      },
                      "body": {
                        "saveToSentItems": false,
                        "message": {
                          "importance": "normal",
                          "from": {
                            "emailAddress": {
                              "name": "Infrastructure Automation",
                              "address": "infra.automation@lebara.com"
                            }
                          },
                          "body": {
                            "content": "<div style=\"font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; max-width: 600px; margin: 0 auto; color: #333;\"><p>Hi @{items('For_Each_Environment')?['Author']?['DisplayName']},</p><p>Your secure RDP connection script for <strong>@{items('For_Each_Environment')?['Title']}</strong> is ready!</p><hr style=\"border: none; border-top: 1px solid #e0e0e0; margin: 20px 0;\"><h3 style=\"color: #0078d4; margin-top: 20px;\">Download Your Connection Script</h3><div style=\"background-color: #e7f3ff; border-left: 4px solid #0078d4; padding: 15px; margin: 20px 0; border-radius: 4px;\"><p style=\"margin: 0 0 10px 0; color: #004085;\"><strong>Script Location:</strong></p><p style=\"margin: 0; color: #004085;\"><a href=\"@{concat('https://lebara.sharepoint.com/sites/ERPConnectionsHub', body('Create_Script_File_in_SharePoint')?['Path'])}\" style=\"color: #0078d4; text-decoration: none; font-weight: 600;\"> Download Connection Script</a></p></div><hr style=\"border: none; border-top: 1px solid #e0e0e0; margin: 20px 0;\"><h3 style=\"color: #0078d4;\">How to Use</h3><ol style=\"line-height: 1.8; padding-left: 20px;\"><li>Click the download link above to get your script</li><li>Save it to your computer</li><li>Double-click the .bat file to run it</li><li>Follow the on-screen prompts to connect</li></ol><div style=\"background-color: #e7f3ff; border-left: 4px solid #0078d4; padding: 15px; margin: 20px 0; border-radius: 4px;\"><strong style=\"color: #004085;\">Connection Details:</strong><ul style=\"margin: 10px 0 0 0; padding-left: 20px; color: #004085;\"><li>VM Name: @{outputs('Set_VM_Details')?['vmName']}</li><li>Resource Group: @{items('For_Each_Environment')?['Resource_x0020_Group_x0020_Name']}</li><li>Connection Method: Secure Azure Bastion</li></ul></div><hr style=\"border: none; border-top: 1px solid #e0e0e0; margin: 20px 0;\"><div style=\"background-color: #fff3cd; border-left: 4px solid #ffc107; padding: 15px; margin: 20px 0; border-radius: 4px;\"><strong style=\"color: #856404;\">Security Note:</strong><p style=\"margin: 10px 0 0 0; color: #856404;\">This script uses Azure Bastion for secure connectivity. Do not attempt direct RDP connections as they are blocked by NSG rules.</p></div><hr style=\"border: none; border-top: 1px solid #e0e0e0; margin: 20px 0;\"><h3 style=\"color: #0078d4;\">Quick Links</h3><ul style=\"list-style: none; padding: 0;\"><li style=\"padding: 5px 0;\"><a href=\"https://lebara.sharepoint.com/sites/ERPConnectionsHub/Lists/Environment%20Requests/DispForm.aspx?ID=@{items('For_Each_Environment')?['ID']}\" style=\"color: #0078d4; text-decoration: none;\"> View Request in SharePoint</a></li><li style=\"padding: 5px 0;\"><a href=\"https://portal.azure.com/#@lebara.com/resource/subscriptions/8cc0a954-47fb-4878-a768-e195dbd036b7/resourceGroups/@{items('For_Each_Environment')?['Resource_x0020_Group_x0020_Name']}/overview\" style=\"color: #0078d4; text-decoration: none;\"> View Resource Group in Azure Portal</a></li></ul><hr style=\"border: none; border-top: 1px solid #e0e0e0; margin: 20px 0;\"><p style=\"color: #666; font-size: 13px;\">Need assistance? Contact the Infrastructure Team: <a href=\"mailto:infrastructure@lebara.com\" style=\"color: #0078d4; text-decoration: none;\">infrastructure@lebara.com</a></p><p style=\"color: #666; font-size: 13px; margin-top: 30px;\"><strong>Infrastructure Automation</strong></p></div>",
                            "contentType": "HTML"
                          },
                          "toRecipients": [
                            {
                              "emailAddress": {
                                "address": "@items('For_Each_Environment')?['Author']?['Email']"
                              }
                            }
                          ],
                          "subject": " Your D365 Connection Script is Ready: @{items('For_Each_Environment')?['Title']}"
                        }
                      },
                      "headers": {
                        "Content-Type": "application/json"
                      },
                      "uri": "https://graph.microsoft.com/v1.0/users/infra.automation@lebara.com/sendMail"
                    }
                  },
                  "Set_VM_Details": {
                    "type": "Compose",
                    "inputs": {
                      "vmName": "@body('Parse_VM_Response')?['value'][0]['name']",
                      "vmResourceId": "@body('Parse_VM_Response')?['value'][0]['id']"
                    }
                  },
                  "Update_SharePoint_Item": {
                    "runAfter": {
                      "Create_Script_File_in_SharePoint": [
                        "Succeeded"
                      ]
                    },
                    "type": "ApiConnection",
                    "inputs": {
                      "body": {
                        "BusinessJustification": "@items('For_Each_Environment')?['BusinessJustification']",
                        "Connection_x0020_Script": "@{concat('https://lebara.sharepoint.com/sites/ERPConnectionsHub', body('Create_Script_File_in_SharePoint')?['Path'])}",
                        "Title": "@items('For_Each_Environment')?['Title']",
                        "VM_x0020_Name": "@{outputs('Set_VM_Details')?['vmName']}"
                      },
                      "host": {
                        "connection": {
                          "name": "@parameters('$connections')['sharepointonline']['connectionId']"
                        }
                      },
                      "method": "patch",
                      "path": "/datasets/@{encodeURIComponent(encodeURIComponent('https://lebara.sharepoint.com/sites/ERPConnectionsHub'))}/tables/@{encodeURIComponent(encodeURIComponent('Environment Requests'))}/items/@{encodeURIComponent(items('For_Each_Environment')?['ID'])}"
                    }
                  }
                },
                "runAfter": {
                  "Parse_VM_Response": [
                    "Succeeded"
                  ]
                },
                "else": {
                  "actions": {}
                },
                "expression": {
                  "and": [
                    {
                      "greater": [
                        "@length(body('Parse_VM_Response')?['value'])",
                        0
                      ]
                    }
                  ]
                },
                "type": "If"
              },
              "Get_VMs_in_Resource_Group": {
                "type": "Http",
                "inputs": {
                  "authentication": {
                    "audience": "https://management.azure.com",
                    "type": "ManagedServiceIdentity"
                  },
                  "method": "GET",
                  "uri": "https://management.azure.com/subscriptions/8cc0a954-47fb-4878-a768-e195dbd036b7/resourceGroups/@{items('For_Each_Environment')?['Resource_x0020_Group_x0020_Name']}/providers/Microsoft.Compute/virtualMachines?api-version=2024-11-01"
                }
              },
              "Parse_VM_Response": {
                "runAfter": {
                  "Get_VMs_in_Resource_Group": [
                    "Succeeded"
                  ]
                },
                "type": "ParseJson",
                "inputs": {
                  "content": "@body('Get_VMs_in_Resource_Group')",
                  "schema": {
                    "properties": {
                      "value": {
                        "items": {
                          "properties": {
                            "id": {
                              "type": "string"
                            },
                            "location": {
                              "type": "string"
                            },
                            "name": {
                              "type": "string"
                            }
                          },
                          "type": "object"
                        },
                        "type": "array"
                      }
                    },
                    "type": "object"
                  }
                }
              }
            },
            "else": {
              "actions": {}
            },
            "expression": {
              "and": [
                {
                  "greaterOrEquals": [
                    "@ticks(items('For_Each_Environment')?['Created'])",
                    "@ticks(addDays(utcNow(), -2))"
                  ]
                }
              ]
            },
            "type": "If"
          }
        },
        "runAfter": {
          "Get_Items_Needing_Scripts": [
            "Succeeded"
          ]
        },
        "type": "Foreach",
        "runtimeConfiguration": {
          "concurrency": {
            "repetitions": 1
          }
        }
      },
      "Get_Items_Needing_Scripts": {
        "runAfter": {},
        "type": "ApiConnection",
        "inputs": {
          "host": {
            "connection": {
              "name": "@parameters('$connections')['sharepointonline']['connectionId']"
            }
          },
          "method": "get",
          "path": "/datasets/@{encodeURIComponent(encodeURIComponent('https://lebara.sharepoint.com/sites/ERPConnectionsHub'))}/tables/@{encodeURIComponent(encodeURIComponent('194aeb23-75c2-47ec-88c7-90db9c468681'))}/items",
          "queries": {
            "$filter": "Connection_x0020_Script eq null and Resource_x0020_Group_x0020_Name ne null"
          }
        }
      }
    },
    "outputs": {}
  },
  "Parameters": {
    "$connections": {
      "Type": "Object",
      "Value": {
        "office365": {
          "connectionId": "/subscriptions/8cc0a954-47fb-4878-a768-e195dbd036b7/resourceGroups/rg-lebara-automation/providers/Microsoft.Web/connections/office365",
          "connectionName": "office365",
          "id": "/subscriptions/8cc0a954-47fb-4878-a768-e195dbd036b7/providers/Microsoft.Web/locations/northeurope/managedApis/office365"
        },
        "sharepointonline": {
          "connectionId": "/subscriptions/8cc0a954-47fb-4878-a768-e195dbd036b7/resourceGroups/rg-lebara-automation/providers/Microsoft.Web/connections/sharepointonline",
          "connectionName": "sharepointonline",
          "id": "/subscriptions/8cc0a954-47fb-4878-a768-e195dbd036b7/providers/Microsoft.Web/locations/northeurope/managedApis/sharepointonline"
        }
      },
      "Metadata": null,
      "Description": null
    }
  },
  "Id": "/subscriptions/8cc0a954-47fb-4878-a768-e195dbd036b7/resourceGroups/rg-lebara-automation/providers/Microsoft.Logic/workflows/la-d365-connection-script-generator",
  "Name": "la-d365-connection-script-generator",
  "Type": "Microsoft.Logic/workflows",
  "Location": "northeurope",
  "Tags": null
}
